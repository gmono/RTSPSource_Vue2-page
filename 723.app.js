(self.webpackChunk_cyanstats_frontend=self.webpackChunk_cyanstats_frontend||[]).push([[723],{109:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>o});var i=n(601),r=n.n(i),a=n(314),s=n.n(a)()(r());s.push([t.id,"\n.video-container[data-v-4e8c4374] {\r\n  width: 100%;\r\n  height: 100%;\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  position: relative;\n}\ncanvas[data-v-4e8c4374] {\r\n  width: 100%;\r\n  /* 使用百分比宽度来填充容器 */\r\n  height: 100%;\r\n  /* 使用百分比高度来填充容器 */\r\n  object-fit: contain;\n}\n.play-btn>img[data-v-4e8c4374] {\r\n  height: 100%;\r\n  width: 100%;\n}\n.play-btn[data-v-4e8c4374] {\r\n  transition: all ease-in-out 0.05s;\n}\n.play-btn[data-v-4e8c4374]:hover {\r\n  transform: scale(1.05);\n}\n.play-btn[data-v-4e8c4374]:active {\r\n  transform: scale(0.98);\n}\r\n\r\n\r\n/* ------------- */\n.progress[data-v-4e8c4374] {\r\n  position: relative;\r\n  width: 100%;\r\n  height: 20px;\r\n  /* 进度条高度 */\n}\n.progress-background[data-v-4e8c4374] {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #ccc;\r\n  /* 背景条颜色 */\r\n  border-radius: 4px;\r\n  /* 可选：圆角 */\n}\n.progress-bar[data-v-4e8c4374] {\r\n  height: 100%;\r\n  background-color: #4caf50;\r\n  /* 进度条颜色 */\r\n  border-radius: 4px;\r\n  /* 可选：圆角 */\r\n  transition: width 0.1s linear;\r\n  /* 平滑过渡效果 */\n}\n.progress-time[data-v-4e8c4374] {\r\n  position: absolute;\r\n  top: -20px;\r\n  /* 显示在进度条上方 */\r\n  right: 0;\r\n  font-size: 12px;\r\n  color: #333;\n}\n.bottom-bar[data-v-4e8c4374] {\r\n  opacity: 0;\r\n  pointer-events: none;\r\n  transition: all ease 0.2s 0.1s;\n}\n.top:hover .bottom-bar[data-v-4e8c4374] {\r\n  opacity: 1;\r\n  pointer-events: unset;\n}\r\n",""]);const o=s},831:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>F});var i=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",[e("h1",[t._v("组件版本:"+t._s(t.version))]),t._v(" "),e("div",[e("div",[e("span",[t._v("视频流URL")]),t._v(" "),e("input",{directives:[{name:"model",rawName:"v-model",value:t.url,expression:"url"}],domProps:{value:t.url},on:{input:function(e){e.target.composing||(t.url=e.target.value)}}}),t._v(" "),e("span",[t._v("RTC服务器")]),t._v(" "),e("input",{directives:[{name:"model",rawName:"v-model",value:t.server,expression:"server"}],domProps:{value:t.server},on:{input:function(e){e.target.composing||(t.server=e.target.value)}}})])]),t._v(" "),e("div",[e("div",[t._v("received:"+t._s(t.received))])]),t._v(" "),e("div",[e("div",[t._v("boxlen:"+t._s(t.boxs.length))]),t._v(" "),t._l(t.boxs,(function(n,i){return e("div",{key:i},[e("div",[t._v("y:"+t._s(n.x)+" x:"+t._s(n.y)+" height:"+t._s(n.h)+" width:"+t._s(n.w)+" cls:"+t._s(n.cls)+" conf:"+t._s(n.conf)+"\n      ")])])}))],2),t._v(" "),e("RTSPVideo",{ref:"player",attrs:{withHead:!0,headRender:t.renderHead,updateframeReceived:t.onreceived,url:t.url,rtcServer:t.server}}),t._v(" "),e("div",[e("button",{on:{click:t.click}},[t._v("播放")])])],1)};i._withStripped=!0;var r=function(){var t=this._self._c;return t("div",{ref:"ele",staticClass:"top",staticStyle:{display:"flex","min-height":"500px","flex-direction":"column",position:"relative"}},[t("div",{staticStyle:{flex:"1",contain:"size",background:"black",position:"relative"}},[t("canvas",{ref:"canvasElement"})])])};r._withStripped=!0;var a=n(893),s=n(468),o=function(t,e,n,i){return new(n||(n=Promise))((function(r,a){function s(t){try{h(i.next(t))}catch(t){a(t)}}function o(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}h((i=i.apply(t,e||[])).next())}))},h=function(t,e){var n,i,r,a,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(h){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,h])}}};function u(t,e){return o(this,void 0,void 0,(function(){function n(){return o(this,void 0,void 0,(function(){var n,i,r,a,s;return h(this,(function(o){switch(o.label){case 0:return[4,navigator.gpu.requestAdapter()];case 1:return(n=o.sent())?[4,n.requestDevice()]:(console.error("No suitable GPU adapter found"),[2,null]);case 2:return i=o.sent(),r=t.MakeGPUDeviceContext(i),console.log("gpu设备上下文:",r),r?(a=t.MakeGPUCanvasContext(r,e))?(s=t.MakeGPUCanvasSurface(a,t.ColorSpace.SRGB))?[2,s]:(console.error("Failed to create surface"),[2,null]):(console.error("Failed to create WebGPU canvas context"),[2,null]):(console.error("Failed to create WebGPU device context"),[2,null])}}))}))}return h(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,n()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))}function c(t,e){return o(this,void 0,void 0,(function(){var n;return h(this,(function(i){switch(i.label){case 0:return[4,u(t,e)];case 1:return null==(n=i.sent())?(console.log("使用WebGL/CPU surface"),[2,t.MakeCanvasSurface(e)]):(console.log("使用GPU surface"),[2,n])}}))}))}!function(){function t(t,e,n){void 0===n&&(n="avc1.42E01E");var i=this;this.frameIdx=0,this.videoDecoder=new VideoDecoder({output:function(t){i.render&&i.render(t)},error:function(t){console.error("Decoder error:",t)}}),this.videoDecoder.configure({codec:n,codedHeight:t,codedWidth:e})}t.prototype.decodeAsync=function(t){},t.prototype.decode=function(t){var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=new EncodedVideoChunk({type:0===this.frameIdx?"key":"delta",timestamp:this.frameIdx*(1e3/30),data:e});this.videoDecoder.decode(n),this.frameIdx++}}();var l=function(){function t(t,e,n){this.canvas=t,this.ins=e,this.wh=n,this.paint=new e.Paint}return t.prototype.renderVideoFrame=function(t){return o(this,void 0,void 0,(function(){var e;return h(this,(function(n){switch(n.label){case 0:return e=this.ins.MakeImageFromCanvasImageSource(t),[4,this.renderImg(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.renderEncodedImage=function(t){var e=this.ins.MakeImageFromEncoded(t);if(!e)throw"Frame图像解码失败";this.renderImg(e),e.delete()},t.prototype.renderEncodeImage2=function(t){return o(this,void 0,void 0,(function(){var e,n,i,r;return h(this,(function(a){switch(a.label){case 0:return[4,createImageBitmap(new Blob([t]))];case 1:return e=a.sent(),n=this.ins.LTRBRect(0,0,e.width,e.height),i=this.ins.LTRBRect(0,0,this.wh.width,this.wh.height),r=this.ins.MakeImageFromCanvasImageSource(e),this.canvas.drawImageRect(r,n,i,this.paint,!0),[2]}}))}))},t.prototype.renderImg=function(t){var e=this.ins.LTRBRect(0,0,t.width(),t.height()),n=this.ins.LTRBRect(0,0,this.wh.width,this.wh.height);this.canvas.drawImageRect(t,e,n,this.paint,!0)},t}(),d=n(404);const f=n.p+"be9bc045c9bf9e332c7fced2eb82cbb4.gif",p=n.p+"3e94c5877edab24a9b471a66ee7794a1.png",v=(n.p,n.p+"1f076f6eb3670c53bb1f9a685da8c547.png");var m=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],i=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},y=(function(){function t(t){void 0===t&&(t=100),this.objs=[],this.used=new Set,this.size=0,this.step=10,this.addCap(t)}t.prototype.addCap=function(t){var e,n;null==t&&(t=this.step);try{for(var i=m((0,d.range)(t)),r=i.next();!r.done;r=i.next())r.value,this.objs.push({})}catch(t){e={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}this.size+=t,console.log("对象池数量扩大到:"+this.size)},t.prototype.get=function(){0==this.objs.length&&this.addCap();var t=this.objs.pop();return this.used.add(t),t},t.prototype.inuse=function(t){return this.used.has(t)},t.prototype.free=function(t){this.used.has(t)&&(this.used.delete(t),this.objs.push(t))}}(),function(){function t(t,e,n){void 0===n&&(n=!1),this.encoder=t,this.withHead=e,this.usePool=n,this.frameInfo={height:void 0,width:void 0},this.hasInit=!1}return t.prototype.freeRes=function(t){this.usePool&&this.pool.free(t)},t.prototype.getObj=function(){return this.usePool?this.pool.get():{}},t.prototype.unpack=function(t){try{var e=this.getObj();this.withHead||(e.frame=g.bufferToArraybuffer(t),e.head=null);var n=new x,i=n.readFromBuffer(t);if(n.isInit&&(this.frameInfo.height=n.height,this.frameInfo.width=n.width),n.hasFrame)var r=t.subarray(i,-1),a=this.decode(r);else console.log("接收到数据帧(音频帧)");return e.frame=a,e.head=n,e}catch(t){return null}},t.prototype.decode=function(t){if(this.encoder.endsWith(".zip"))throw"暂不支持ZIP压缩帧";return g.bufferToArraybuffer(t)},t}()),g=function(){function t(){}return t.bufferToArraybuffer=function(t){return t.buffer.slice(t.byteOffset,t.byteLength)},t}(),w=function(){function t(){this.x=0,this.y=0,this.w=0,this.h=0,this.cls=0,this.conf=0}return t.prototype.readFromBuffer=function(t,e){var n=e;return this.x=t.readFloatLE(n),n+=4,this.y=t.readFloatLE(n),n+=4,this.w=t.readFloatLE(n),n+=4,this.h=t.readFloatLE(n),n+=4,this.cls=t.readInt32LE(n),n+=4,this.conf=t.readFloatLE(n),n+4},t.prototype.writeToBuffer=function(t,e){var n=e;return t.writeFloatLE(this.x,n),n+=4,t.writeFloatLE(this.y,n),n+=4,t.writeFloatLE(this.w,n),n+=4,t.writeFloatLE(this.h,n),n+=4,t.writeInt32LE(this.cls,n),n+=4,t.writeFloatLE(this.conf,n),n+4},t.prototype.getSize=function(){return 24},t}(),b=function(){function t(){this.boxs=null}return t.prototype.readFromBuffer=function(t,e){var n=e,i=t.readInt32LE(n);if(n+=4,0===i)this.boxs=null;else{this.boxs=[];for(var r=0;r<i;r++){var a=new w;n=a.readFromBuffer(t,n),this.boxs.push(a)}}return n},t.prototype.writeToBuffer=function(t,e){var n,i,r=e;if(this.boxs){t.writeInt32LE(this.boxs.length,r),r+=4;try{for(var a=m(this.boxs),s=a.next();!s.done;s=a.next())r=s.value.writeToBuffer(t,r)}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}}else t.writeInt32LE(0,r),r+=4;return r},t.prototype.getSize=function(){return this.boxs?4+24*this.boxs.length:4},t}(),x=function(){function t(){this.hasHead=!1,this.hasFrame=!0,this.timeOffset=0,this.height=0,this.width=0,this.isInit=!1,this.isKey=!1,this.boxs=null,this.audio=null}return t.prototype.readFromBuffer=function(t,e){void 0===e&&(e=0);var n=e;this.hasHead=0!==t.readUInt8(n),n+=1,this.hasFrame=0!==t.readUInt8(n),n+=1,this.timeOffset=t.readFloatLE(n),n+=4,this.height=t.readInt32LE(n),n+=4,this.width=t.readInt32LE(n),n+=4,this.isInit=0!==t.readUInt8(n),n+=1,this.isKey=0!==t.readUInt8(n),n+=1;var i=0!==t.readUInt8(n);n+=1,i?(this.boxs=new b,n=this.boxs.readFromBuffer(t,n)):this.boxs=null;var r=t.readInt32LE(n);return n+=4,r>0?(console.log("audio length:",r),this.audio=t.subarray(n,n+r),n+=r):this.audio=null,n},t.prototype.writeToBuffer=function(t,e){void 0===e&&(e=0);var n=e;return t.writeUInt8(this.hasHead?1:0,n),n+=1,t.writeUInt8(this.hasFrame?1:0,n),n+=1,t.writeFloatLE(this.timeOffset,n),n+=4,t.writeInt32LE(this.height,n),n+=4,t.writeInt32LE(this.width,n),n+=4,t.writeUInt8(this.isInit?1:0,n),n+=4,t.writeUInt8(this.isKey?1:0,n),n+=1,this.boxs?(t.writeUInt8(1,n),n+=1,n=this.boxs.writeToBuffer(t,n)):(t.writeUInt8(0,n),n+=1),this.audio?(t.writeInt32LE(this.audio.length,n),n+=4,this.audio.copy(t,n),n+=this.audio.length):(t.writeInt32LE(0,n),n+=4),n},t.prototype.getSize=function(){var t=18;return this.boxs&&(t+=this.boxs.getSize()),t+=4,this.audio&&(t+=this.audio.length),t},t.prototype.toString=function(){var t;return"HeadData {\n      hasHead: ".concat(this.hasHead,",\n      hasFrame: ").concat(this.hasFrame,",\n      timeOffset: ").concat(this.timeOffset,",\n      height: ").concat(this.height,",\n      width: ").concat(this.width,",\n      isInit: ").concat(this.isInit,",\n      isKey: ").concat(this.isKey,",\n      boxs: ").concat(this.boxs?(null===(t=this.boxs.boxs)||void 0===t?void 0:t.length)+" rectangles":"null","\n    }")},t}();const I=function(){function t(t,e,n){void 0===t&&(t=44100),void 0===e&&(e=2),void 0===n&&(n=16),this.bufferQueue=[],this.isPlaying=!1,this.nextStartTime=0,this.maxQueueLength=10,this.audioCtx=new AudioContext({sampleRate:t}),this.sampleRate=t,this.channels=e,this.bitsPerSample=n}return t.prototype.addPcmData=function(t){if(t.byteLength%2!=0)throw new Error("PCM 数据长度必须是 2 的倍数（16-bit PCM）");var e=new Uint8Array(t),n=e.byteLength/2,i=new Int16Array(e.buffer,0,n);this.bufferQueue.length>=this.maxQueueLength&&(this.bufferQueue.shift(),console.warn("队列已满，丢弃最早的缓冲区，当前长度: ".concat(this.bufferQueue.length))),this.bufferQueue.push(i),this.isPlaying&&this.playNextBuffer()},t.prototype.start=function(){this.isPlaying||(this.isPlaying=!0,this.nextStartTime=this.audioCtx.currentTime,this.playNextBuffer(),this.loop())},t.prototype.loop=function(){return t=this,e=void 0,i=function(){return function(t,e){var n,i,r,a,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(h){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,h])}}}(this,(function(t){switch(t.label){case 0:return this.isPlaying?[4,(e=10,void 0===e&&(e=100),new Promise((function(t,n){requestIdleCallback((function(e){return t(e)}),{timeout:e})})))]:[3,2];case 1:return t.sent(),this.playNextBuffer(),[3,0];case 2:return[2]}var e}))},new((n=void 0)||(n=Promise))((function(r,a){function s(t){try{h(i.next(t))}catch(t){a(t)}}function o(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,o)}h((i=i.apply(t,e||[])).next())}));var t,e,n,i},t.prototype.stop=function(){this.isPlaying=!1,this.bufferQueue=[],this.nextStartTime=0,this.audioCtx.close().then((function(){return console.log("AudioContext 已关闭")}))},t.prototype.playNextBuffer=function(){var t=this;if(0!==this.bufferQueue.length){for(var e=this.bufferQueue.shift(),n=e.length/this.channels,i=n/this.sampleRate,r=this.audioCtx.createBuffer(this.channels,n,this.sampleRate),a=0;a<this.channels;a++)for(var s=r.getChannelData(a),o=0;o<n;o++)s[o]=e[o*this.channels+a]/32768;var h=this.audioCtx.createBufferSource();h.buffer=r,h.connect(this.audioCtx.destination),h.start(this.nextStartTime),this.nextStartTime+=i,console.log("播放缓冲区: ".concat(n," 样本, 时长: ").concat(1e3*i," 毫秒, 下次开始: ").concat(this.nextStartTime)),h.onended=function(){return t.playNextBuffer()}}},t.prototype.getBufferedBytes=function(){return this.bufferQueue.reduce((function(t,e){return t+2*e.length}),0)},t}();var S=n(287).hp;console.log("图片",p);const k={props:{withAudio:{type:Boolean,default:!0},autoPlayAudio:{type:Boolean,default:!0},showDebug:{type:Boolean,default:!0},headRender:{type:Function,default:null},updateframeReceived:{type:Function,default:null},updateframeRendered:{type:Function,default:null},updateframeAvoided:{type:Function,default:null},withHead:{type:Boolean,default:!1},rtcServer:{type:String,default:"http://localhost:8000/rtsp"},url:{type:String},targetSize:{type:Object,default:()=>null},canvasSize:{type:Object,default:()=>null},token:{type:String,default:()=>null}},data:()=>({currentTime:0,totalTime:null,state:0,ws:null,canvasElement:null,canvasKitInstance:null,surface:null,paint:null,painting:!1,frameQueue:[],maxQueue:2,encoder:"default",initok:!1,observer:null,currSize:null,loopToken:!0,autoResize_task:null,mainTask:null,avoidFrames:0,renderFrames:0,loading:!1,play_loading:!1,playImg:p,loadingImg:f,stopImg:v,frameIdx:0,renderedIdx:0,frameParser:null,innerPlayer:null}),async mounted(){this.initok=!1,this.canvasElement=this.$refs.canvasElement,await this.loadCanvasKit(),this.initok=!0,this.startAutoResize()},async beforeDestroy(){window.removeEventListener("resize",this.updateCanvasSize),await this.waitAutosizeEnd(),await this.waitMainTask()},computed:{address(){return this.rtcServer},progressPercentage(){return this.totalTime&&this.totalTime>0?this.currentTime/this.totalTime*100:0},timeDisplay(){const t=t=>{const e=Math.floor(t/60),n=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},e=t(this.currentTime);return this.totalTime&&this.totalTime>0?`${e} / ${t(this.totalTime)}`:`${e} / 直播中`}},methods:{recordFrameReceived(){this.frameIdx++,this.updateframeReceived&&this.updateframeReceived(this.frameIdx)},recordFrameRendered(){this.renderedIdx++,this.updateframeRendered&&this.updateframeRendered(this.renderedIdx)},getCurrentTime:()=>0,getTotalTime:()=>null,onclick(){this.loading||this.play_loading||(0==this.state?this.play():this.stop())},startAutoResize(){this.autoResize_task=this.autoResize()},async waitAutosizeEnd(){this.autoResize_task&&(this.loopToken=!1,await this.autoResize_task,this.autoResize_task=null)},async autoResize(){for(;this.loopToken;){let t=this.getEleWH(),e=this.getwh();(null==this.currSize||Math.abs(e.height-t.height)>10||Math.abs(e.width-t.width)>10)&&(console.log("自动更新画布大小"),this.updateToReal()),await(0,d.delay)(1e3)}},async loadCanvasKit(){try{this.updateSizeByProps(),this.canvasKitInstance=await s({locateFile:t=>`/${t}`}),this.surface=await c((0,a.toRaw)(this.canvasKitInstance),(0,a.toRaw)(this.canvasElement)),this.paint=new this.canvasKitInstance.Paint}catch(t){console.error("CanvasKit 加载失败:",t)}},async waitMainTask(){this.mainTask&&(await this.mainTask,this.mainTask=null)},async reInitCanvas(){console.log("重设canvas");let t=this.surface;this.surface=null,t.deleteLater(),await this.waitMainTask(),this.updateSizeByProps(),this.surface=await c((0,a.toRaw)(this.canvasKitInstance),(0,a.toRaw)(this.canvasElement)),this._startLoop()},getwh(){return{width:this.canvasElement.width,height:this.canvasElement.height}},getEleWH(){var t=this.$refs.ele.getBoundingClientRect();return{height:t.height,width:t.width}},updateSizeByProps(){this.canvasSize?this.updateSize(this.canvasSize):this.updateToReal()},updateToReal(){this.updateSize(this.getEleWH())},updateSize({height:t,width:e}){console.log(`设置实际画布大小:${e}x${t}`),this.canvasElement.height=t,this.canvasElement.width=e,this.currSize={height:t,width:e},this.$forceUpdate()},async play(){if(!this.loading){if(this.loading=!0,this.play_loading=!0,0===this.state){console.log("开始播放"),this.state=1,this.frameParser=new y(this.encoder,this.withHead),this.ws=new WebSocket(this.address);const t=this.ws;t.onopen=()=>{console.log("数据连接已建立"),t.send(JSON.stringify({url:this.url,targetSize:this.targetSize,withHead:this.withHead,encoder:this.encoder,withAudio:this.withAudio})),this._startLoop()},t.onmessage=this.onWebSocketMessage,t.onerror=t=>{console.error("WebSocket error:",t)},t.onclose=()=>{console.log("WebSocket connection closed")},this.state=1}this.loading=!1}},async onWebSocketMessage(t){this.play_loading&&(this.play_loading=!1);let e=t.data;this.painting||(this.painting=!0,e instanceof ArrayBuffer?this.drawFrame(e):e instanceof Blob?(e=await e.arrayBuffer(),this.drawFrame(e)):console.error("错误的数据类型",e),this.painting=!1)},decode(t){return this.frameParser.unpack(S.from(t))},recordAvoided(){this.avoidFrames++,this.updateframeAvoided&&this.updateframeAvoided(this.avoidFrames)},drawFrame(t){this.recordFrameReceived();let e=this.decode(t);if(this.frameQueue.length>this.maxQueue){this.recordAvoided();const t=this.frameQueue.shift();this.frameParser.freeRes(t)}this.frameQueue.push(e)},nextFrame(){return this.frameQueue.length>0?this.frameQueue.shift():null},_startLoop(){this.mainTask=this.startLoop()},renderHead(t){this.autoPlayAudio&&(this.innerPlayer||(this.innerPlayer=new I(44100,2,16),this.innerPlayer.start()),t.audio&&this.innerPlayer.addPcmData(t.audio)),this.headRender&&this.headRender(t)},startLoop(){const t=this;if(null==this.canvasKitInstance)throw new Error("错误,canvas lib未初始化");const e=this.canvasKitInstance.BLACK,n=this.getwh();if(!this.surface)throw new Error("错误，Surface未就绪无法启动循环");this.surface.requestAnimationFrame((function i(r){var a=t.nextFrame();null!=a?(a.frame&&(r.clear(e),new l(r,t.canvasKitInstance,n).renderEncodedImage(a.frame),t.recordFrameRendered()),a.head&&t.renderHead(a.head),t.frameParser.freeRes(a),t.surface&&t.surface.requestAnimationFrame(i)):t.surface.requestAnimationFrame(i)}))},stop(){this.loading||(this.loading=!0,1===this.state&&(this.state=0,this.ws&&this.ws.close()),this.loading=!1)}}};n(372);var R=n(486);const _=(0,R.A)(k,r,[],!1,null,"4e8c4374",null).exports,E=a.default.extend({components:{RTSPVideo:_},data:function(){return{version:"0.5.8",received:0,rendered:0,avoided:0,boxs:[],url:"rtsp://192.168.199.126:8080/h264_aac.sdp",server:"http://localhost:8000/rtsp"}},methods:{click:function(){this.$refs.player.play()},onreceived:function(t){this.received=t},renderHead:function(t){t.audio&&t.boxs&&(this.boxs=t.boxs.boxs)}}}),F=(0,R.A)(E,i,[],!1,null,"1477d1ff",null).exports},372:(t,e,n)=>{var i=n(109);i.__esModule&&(i=i.default),"string"==typeof i&&(i=[[t.id,i,""]]),i.locals&&(t.exports=i.locals),(0,n(534).A)("091bf44f",i,!1,{})},479:()=>{},387:()=>{}}]);